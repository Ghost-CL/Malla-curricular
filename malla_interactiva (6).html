<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Malla Interactiva PEM Matemática — Posiciones Fijas (Aprobado Gris)</title>
<style>
  :root{ --bg:#f5f7fb; --shadow:0 6px 18px rgba(0,0,0,0.08); }
  *{box-sizing:border-box}
  body{font-family:Arial, Helvetica, sans-serif; margin:0; background:var(--bg); color:#222}
  header{display:flex;align-items:center;justify-content:space-between;padding:18px 24px;background:linear-gradient(90deg,#ffffffcc,#f0f6ffcc);box-shadow:var(--shadow)}
  header h1{margin:0;font-size:16px}
  .controls{display:flex;gap:10px;align-items:center}
  .btn{padding:8px 12px;border-radius:8px;border:1px solid #e1e7ef;background:#fff;cursor:pointer}
  #creditosTotales{font-weight:700;padding:8px 12px;border-radius:10px;background:#fff;border:1px solid #e1e7ef}

  .canvas-wrap{max-width:1400px;margin:22px auto;position:relative;padding:18px;background:linear-gradient(180deg,#fff,#fbfdff);border-radius:14px;box-shadow:var(--shadow);overflow:hidden}
  #svgLayer{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}
  .grid-area{display:grid;grid-template-columns:repeat(6,1fr);grid-auto-rows:140px;gap:18px;padding:18px}

  .ramo{position:relative;padding:12px;border-radius:12px;color:#fff;cursor:pointer;box-shadow:0 8px 20px rgba(12,26,50,0.08);user-select:none;display:flex;flex-direction:column;justify-content:space-between;transition:all .25s ease}
  .titulo{font-weight:700;margin-bottom:6px}
  .meta{font-size:13px;opacity:0.95}

  .s1{background:linear-gradient(135deg,#6ee7b7,#10b981)}
  .s2{background:linear-gradient(135deg,#fbbf24,#fb923c)}
  .s3{background:linear-gradient(135deg,#a78bfa,#7c3aed)}
  .s4{background:linear-gradient(135deg,#60a5fa,#3b82f6)}
  .s5{background:linear-gradient(135deg,#34d399,#059669)}
  .s6{background:linear-gradient(135deg,#f472b6,#db2777)}
  .s7{background:linear-gradient(135deg,#f59e0b,#b45309)}
  .s8{background:linear-gradient(135deg,#22d3ee,#0ea5e9)}
  .s9{background:linear-gradient(135deg,#6b7280,#374151)}

  /* Nuevo estilo para ramos aprobados: más gris, menos saturación y contraste visual */
  .aprobado{
    filter:grayscale(85%) brightness(0.9) opacity(0.75);
    box-shadow:none;
    transform:scale(0.995);
    border:1px solid rgba(0,0,0,0.06);
  }

  .bloqueado{filter:grayscale(40%) opacity(0.75);border:2px dashed rgba(0,0,0,0.06);cursor:not-allowed}

  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center}
  .modal{background:#fff;padding:18px;border-radius:12px;max-width:520px;width:92%;box-shadow:var(--shadow)}
  .row{display:flex;gap:8px;align-items:center}

  @media (max-width:1024px){ .ramo{min-height:70px} }
  @media (max-width:720px){ .grid-area{grid-template-columns:repeat(2,1fr);grid-auto-rows:120px} }
  footer{max-width:1400px;margin:12px auto;text-align:center;color:#666;padding-bottom:30px}
</style>
</head>
<body>
<header>
  <h1>PEM Matemática — Malla Interactiva (Aprobado gris)</h1>
  <div class="controls">
    <div id="creditosTotales">Créditos: 0</div>
    <button class="btn" id="resetBtn">Restablecer</button>
    <button class="btn" id="exportBtn">Exportar</button>
    <button class="btn" id="importBtn">Importar</button>
  </div>
</header>

<main>
  <div class="canvas-wrap" id="canvasWrap">
    <svg id="svgLayer" xmlns="http://www.w3.org/2000/svg"></svg>
    <div class="grid-area" id="gridArea" aria-hidden="false"></div>

    <template id="ramoTemplate">
      <div class="ramo">
        <div class="titulo"></div>
        <div class="meta"></div>
      </div>
    </template>

    <script id="dataRamos" type="application/json">
[
  {"nombre":"COMUNICACIÓN EN ESPAÑOL","prer":"","creditos":4,"desc":"Desarrollo de habilidades comunicativas académicas.","row":1,"col":1,"cls":"s1"},
  {"nombre":"EDUCACIÓN Y SOCIEDAD","prer":"","creditos":4,"desc":"Vínculos entre sistemas educativos y sociedad.","row":1,"col":2,"cls":"s1"},
  {"nombre":"INFORMÁTICA EDUCATIVA","prer":"","creditos":4,"desc":"Uso pedagógico de TIC en educación.","row":1,"col":3,"cls":"s1"},
  {"nombre":"ARITMÉTICA","prer":"","creditos":6,"desc":"Estructuras y razonamiento aritmético.","row":1,"col":4,"cls":"s1"},
  {"nombre":"INTRODUCCIÓN AL ÁLGEBRA","prer":"","creditos":8,"desc":"Conceptos básicos de álgebra y demostración.","row":1,"col":5,"cls":"s1"},
  {"nombre":"FUNDAMENTOS FILOSÓFICOS","prer":"","creditos":4,"desc":"Bases filosóficas de la educación.","row":1,"col":6,"cls":"s1"},

  

  {"nombre":"APRENDIZAJE Y DESARROLLO HUMANO","prer":"EDUCACIÓN Y SOCIEDAD","creditos":4,"desc":"Procesos del desarrollo y aprendizaje humano.","row":2,"col":2,"cls":"s2"},
  {"nombre":"PERSPECTIVAS CURRICULARES EN EDUCACIÓN","prer":"EDUCACIÓN Y SOCIEDAD","creditos":4,"desc":"Teorías y diseño del currículum.","row":2,"col":3,"cls":"s2"},
  {"nombre":"INTRODUCCIÓN AL ANÁLISIS","prer":"ARITMÉTICA,INTRODUCCIÓN AL ÁLGEBRA","creditos":8,"desc":"Fundamentos de análisis matemático.","row":2,"col":4,"cls":"s2"},
  {"nombre":"GEOMETRÍA PLANA","prer":"ARITMÉTICA","creditos":6,"desc":"Elementos de geometría euclidiana.","row":2,"col":5,"cls":"s2"},
  {"nombre":"FUNDAMENTOS TEOLÓGICOS","prer":"FUNDAMENTOS FILOSÓFICOS","creditos":4,"desc":"Dimensión teológica en educación.","row":2,"col":6,"cls":"s2"},

  {"nombre":"FUNDAMENTOS DE LA INVESTIGACIÓN EDUCATIVA","prer":"APRENDIZAJE Y DESARROLLO HUMANO","creditos":4,"desc":"Principios y métodos de investigación educativa.","row":3,"col":1,"cls":"s3"},
  {"nombre":"EVALUACIÓN PARA EL APRENDIZAJE","prer":"PERSPECTIVAS CURRICULARES EN EDUCACIÓN","creditos":4,"desc":"Evaluación formativa y para el aprendizaje.","row":3,"col":2,"cls":"s3"},
  {"nombre":"DIDÁCTICA DE LA ARITMÉTICA","prer":"ARITMÉTICA,PERSPECTIVAS CURRICULARES EN EDUCACIÓN","creditos":6,"desc":"Estrategias para enseñar aritmética.","row":3,"col":3,"cls":"s3"},
  {"nombre":"GEOMETRÍA DEL ESPACIO","prer":"GEOMETRÍA PLANA","creditos":7,"desc":"Geometría tridimensional y transformaciones.","row":3,"col":4,"cls":"s3"},
  {"nombre":"ELEMENTOS DE ANÁLISIS REAL I","prer":"INTRODUCCIÓN AL ANÁLISIS","creditos":7,"desc":"Sucesiones, continuidad y derivación en R.","row":3,"col":5,"cls":"s3"},

  {"nombre":"INCLUSIÓN EN CONTEXTOS EDUCATIVOS","prer":"APRENDIZAJE Y DESARROLLO HUMANO","creditos":4,"desc":"Educación inclusiva y atención a la diversidad.","row":4,"col":1,"cls":"s4"},
  {"nombre":"PRÁCTICA PEDAGÓGICA I","prer":"FUNDAMENTOS DE LA INVESTIGACIÓN EDUCATIVA,EVALUACIÓN PARA EL APRENDIZAJE","creditos":4,"desc":"Experiencia inicial en aula.","row":4,"col":2,"cls":"s4"},
  {"nombre":"DIDÁCTICA DE LA GEOMETRÍA","prer":"GEOMETRÍA DEL ESPACIO,DIDÁCTICA DE LA ARITMÉTICA","creditos":6,"desc":"Metodologías para la enseñanza de la geometría.","row":4,"col":3,"cls":"s4"},
  {"nombre":"ÁLGEBRA LINEAL Y MATRICES","prer":"INTRODUCCIÓN AL ÁLGEBRA","creditos":7,"desc":"Espacios vectoriales, transformaciones y matrices.","row":4,"col":4,"cls":"s4"},
  {"nombre":"ELEMENTOS DE ANÁLISIS REAL II","prer":"ELEMENTOS DE ANÁLISIS REAL I","creditos":7,"desc":"Integración y series en R.","row":4,"col":5,"cls":"s4"},

  {"nombre":"PLANIFICACIÓN DEL CURRÍCULUM Y EVALUACIÓN DE LOS APRENDIZAJES","prer":"PERSPECTIVAS CURRICULARES EN EDUCACIÓN,EVALUACIÓN PARA EL APRENDIZAJE","creditos":4,"desc":"Planificación curricular y evaluación educativa.","row":5,"col":1,"cls":"s5"},
  {"nombre":"PRÁCTICA PEDAGÓGICA II","prer":"PRÁCTICA PEDAGÓGICA I","creditos":4,"desc":"Profundización de práctica en aula.","row":5,"col":2,"cls":"s5"},
  {"nombre":"AZAR Y PROBABILIDADES","prer":"ELEMENTOS DE ANÁLISIS REAL I","creditos":7,"desc":"Modelos aleatorios y probabilidad básica.","row":5,"col":3,"cls":"s5"},
  {"nombre":"ANÁLISIS CONTINUO EN DOS Y TRES DIMENSIONES","prer":"ELEMENTOS DE ANÁLISIS REAL II","creditos":8,"desc":"Cálculo multivariable.","row":5,"col":4,"cls":"s5"},
  {"nombre":"ECUACIONES DIFERENCIALES ORDINARIAS","prer":"ELEMENTOS DE ANÁLISIS REAL II","creditos":7,"desc":"Modelación con EDO y métodos de solución.","row":5,"col":5,"cls":"s5"},

  {"nombre":"POLÍTICA Y GESTIÓN EDUCATIVA","prer":"INCLUSIÓN EN CONTEXTOS EDUCATIVOS","creditos":4,"desc":"Gestión educativa y políticas públicas.","row":6,"col":1,"cls":"s6"},
  {"nombre":"PRÁCTICA PEDAGÓGICA III","prer":"PRÁCTICA PEDAGÓGICA II","creditos":6,"desc":"Práctica intermedia con mayor autonomía.","row":6,"col":2,"cls":"s6"},
  {"nombre":"DIDÁCTICA DEL CÁLCULO","prer":"ANÁLISIS CONTINUO EN DOS Y TRES DIMENSIONES,ECUACIONES DIFERENCIALES ORDINARIAS,DIDÁCTICA DE LA ARITMÉTICA","creditos":6,"desc":"Estrategias para enseñar cálculo.","row":6,"col":3,"cls":"s6"},
  {"nombre":"PROBABILIDADES Y ESTADÍSTICA INFERENCIAL","prer":"AZAR Y PROBABILIDADES","creditos":7,"desc":"Inferencia estadística y estimación.","row":6,"col":4,"cls":"s6"},
  {"nombre":"ESTRUCTURAS ALGEBRAICAS","prer":"ÁLGEBRA LINEAL Y MATRICES","creditos":7,"desc":"Anillos, grupos y homomorfismos básicos.","row":6,"col":5,"cls":"s6"},

  {"nombre":"DISEÑO DE LA INVESTIGACIÓN EDUCATIVA","prer":"FUNDAMENTOS DE LA INVESTIGACIÓN EDUCATIVA,EVALUACIÓN PARA EL APRENDIZAJE","creditos":4,"desc":"Diseños y protocolos de investigación en aula.","row":7,"col":1,"cls":"s7"},
  {"nombre":"PRÁCTICA PEDAGÓGICA IV","prer":"PRÁCTICA PEDAGÓGICA III","creditos":6,"desc":"Práctica avanzada con responsabilidad docente.","row":7,"col":2,"cls":"s7"},
  {"nombre":"DIDÁCTICA DE LA PROBABILIDAD Y DE LA ESTADÍSTICA","prer":"PROBABILIDADES Y ESTADÍSTICA INFERENCIAL,DIDÁCTICA DE LA ARITMÉTICA","creditos":6,"desc":"Didáctica de contenidos estocásticos.","row":7,"col":3,"cls":"s7"},
  {"nombre":"DIDÁCTICA DEL ÁLGEBRA","prer":"ESTRUCTURAS ALGEBRAICAS,DIDÁCTICA DE LA ARITMÉTICA","creditos":6,"desc":"Enseñanza del álgebra escolar y avanzada.","row":7,"col":4,"cls":"s7"},
  {"nombre":"ÉTICA PROFESIONAL","prer":"FUNDAMENTOS FILOSÓFICOS,FUNDAMENTOS TEOLÓGICOS","creditos":4,"desc":"Ética docente y responsabilidad profesional.","row":7,"col":5,"cls":"s7"},

  {"nombre":"INVESTIGACIÓN EN LA PRÁCTICA EDUCATIVA","prer":"DISEÑO DE LA INVESTIGACIÓN EDUCATIVA,PRÁCTICA PEDAGÓGICA IV","creditos":4,"desc":"Indagación basada en la propia práctica.","row":8,"col":1,"cls":"s8"},
  {"nombre":"PRÁCTICA PEDAGÓGICA V","prer":"PRÁCTICA PEDAGÓGICA IV","creditos":8,"desc":"Práctica con alto nivel de autonomía.","row":8,"col":2,"cls":"s8"},
  {"nombre":"HISTORIA DE LA MATEMÁTICA","prer":"ESTRUCTURAS ALGEBRAICAS","creditos":6,"desc":"Desarrollo histórico de ideas matemáticas.","row":8,"col":3,"cls":"s8"},

  {"nombre":"PRÁCTICA PROFESIONAL","prer":"PRÁCTICA PEDAGÓGICA V,ÉTICA PROFESIONAL,INVESTIGACIÓN EN LA PRÁCTICA EDUCATIVA","creditos":30,"desc":"Internado profesional con dedicación completa.","row":9,"col":2,"cls":"s9"}
]
    </script>

  </div>
</main>

<div class="modal-back" id="modalBack">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <h3 id="modalTitle">Ramo</h3>
    <p id="modalCred"></p>
    <p id="modalDesc"></p>
    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button class="btn" id="toggleAprBtn">Marcar/Desmarcar aprobado</button>
      <button class="btn" id="closeModal">Cerrar</button>
    </div>
  </div>
</div>

<footer>
  Las posiciones ahora son fijas en la cuadrícula. Haz clic en cualquier ramo para abrir la ventana y aprobarlo. Si quieres que vuelva la funcionalidad de arrastrar, lo habilito.
</footer>

<script>
const canvasWrap = document.getElementById('canvasWrap');
const svg = document.getElementById('svgLayer');
const gridArea = document.getElementById('gridArea');
const creditosTotales = document.getElementById('creditosTotales');
const modalBack = document.getElementById('modalBack');
const modalTitle = document.getElementById('modalTitle');
const modalCred = document.getElementById('modalCred');
const modalDesc = document.getElementById('modalDesc');
const toggleAprBtn = document.getElementById('toggleAprBtn');
let activeRamo = null;

const LS_KEY_APPROVED = 'pem_malla_aprobados_v1';

function crearRamosDesdeJSON(){
  const data = JSON.parse(document.getElementById('dataRamos').textContent);
  const template = document.getElementById('ramoTemplate');
  data.forEach(item=>{
    const node = template.content.firstElementChild.cloneNode(true);
    node.classList.add(item.cls);
    node.dataset.nombre = item.nombre;
    node.dataset.prerrequisitos = item.prer;
    node.dataset.creditos = item.creditos;
    node.dataset.desc = item.desc;
    node.style.gridColumnStart = item.col;
    node.style.gridRowStart = item.row;
    node.querySelector('.titulo').innerText = item.nombre;
    node.querySelector('.meta').innerText = item.creditos + ' cr';
    node.addEventListener('click', ()=>abrirModal(node));
    gridArea.appendChild(node);
  });
}

function drawAllLines(){
  while(svg.firstChild) svg.removeChild(svg.firstChild);
  const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
  const marker = document.createElementNS('http://www.w3.org/2000/svg','marker');
  marker.setAttribute('id','arrow'); marker.setAttribute('markerWidth','10'); marker.setAttribute('markerHeight','10'); marker.setAttribute('refX','10'); marker.setAttribute('refY','5'); marker.setAttribute('orient','auto');
  const path = document.createElementNS('http://www.w3.org/2000/svg','path'); path.setAttribute('d','M0,0 L10,5 L0,10 z'); path.setAttribute('fill','#2b6cb0'); marker.appendChild(path); defs.appendChild(marker); svg.appendChild(defs);

  const nodes = Array.from(gridArea.querySelectorAll('.ramo'));
  nodes.forEach(dest=>{
    const prereq = (dest.dataset.prerrequisitos||'').split(',').map(s=>s.trim()).filter(Boolean);
    prereq.forEach(name=>{
      const src = nodes.find(n=>n.dataset.nombre === name);
      if(!src) return;
      const p1 = getCenter(src); const p2 = getCenter(dest);
      const dx = p2.x - p1.x; const curvature = Math.min(150, Math.abs(dx)/1.5 + 30);
      const cx1 = p1.x + curvature * Math.sign(dx || 1); const cx2 = p2.x - curvature * Math.sign(dx || 1);
      const pathEl = document.createElementNS('http://www.w3.org/2000/svg','path');
      const d = `M ${p1.x} ${p1.y} C ${cx1} ${p1.y} ${cx2} ${p2.y} ${p2.x} ${p2.y}`;
      pathEl.setAttribute('d',d); pathEl.setAttribute('stroke','#2b6cb0'); pathEl.setAttribute('stroke-width','2'); pathEl.setAttribute('fill','none'); pathEl.setAttribute('marker-end','url(#arrow)'); svg.appendChild(pathEl);
    });
  });
}

function getCenter(el){ const rect = el.getBoundingClientRect(); const cRect = canvasWrap.getBoundingClientRect(); return {x: rect.left - cRect.left + rect.width/2, y: rect.top - cRect.top + rect.height/2}; }

function cargarAprobados(){ const aprobados = JSON.parse(localStorage.getItem(LS_KEY_APPROVED) || '[]'); const nodes = Array.from(gridArea.querySelectorAll('.ramo')); nodes.forEach(n=>{ if(aprobados.includes(n.dataset.nombre)) n.classList.add('aprobado'); }); }

function guardarAprobados(){ const nodes = Array.from(gridArea.querySelectorAll('.ramo')); const aprobados = nodes.filter(n=>n.classList.contains('aprobado')).map(n=>n.dataset.nombre); localStorage.setItem(LS_KEY_APPROVED, JSON.stringify(aprobados)); actualizarCreditos(); }

function actualizarCreditos(){ const nodes = Array.from(gridArea.querySelectorAll('.ramo')); let total=0; nodes.forEach(n=>{ if(n.classList.contains('aprobado')) total += parseInt(n.dataset.creditos||0); }); creditosTotales.innerText = `Créditos: ${total}`; }

function abrirModal(node){ activeRamo = node; modalTitle.innerText = node.dataset.nombre; modalCred.innerText = `Créditos: ${node.dataset.creditos}`; modalDesc.innerText = node.dataset.desc || ''; modalBack.style.display = 'flex'; }
function cerrarModal(){ modalBack.style.display='none'; activeRamo=null; }

document.getElementById('closeModal').addEventListener('click', cerrarModal);
modalBack.addEventListener('click', e=>{ if(e.target===modalBack) cerrarModal(); });

document.getElementById('toggleAprBtn').addEventListener('click', ()=>{
  if(!activeRamo) return;
  if(!activeRamo.classList.contains('aprobado')){
    const prereq = (activeRamo.dataset.prerrequisitos||'').split(',').map(s=>s.trim()).filter(Boolean);
    for(const name of prereq){ const n = Array.from(gridArea.querySelectorAll('.ramo')).find(x=>x.dataset.nombre===name); if(n && !n.classList.contains('aprobado')){ alert('No puedes aprobar: falta \"'+name+'\" como prerrequisito.'); return; } }
    activeRamo.classList.add('aprobado');
  } else { activeRamo.classList.remove('aprobado'); }
  guardarAprobados(); drawAllLines(); cerrarModal();
});

// Reset / Export / Import
document.getElementById('resetBtn').addEventListener('click', ()=>{ if(!confirm('¿Restablecer progreso?')) return; localStorage.removeItem(LS_KEY_APPROVED); location.reload(); });

document.getElementById('exportBtn').addEventListener('click', ()=>{ const data = {aprobados: JSON.parse(localStorage.getItem(LS_KEY_APPROVED)||'[]')}; const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='progreso_pem_malla.json'; a.click(); URL.revokeObjectURL(url); });

document.getElementById('importBtn').addEventListener('click', ()=>{ const input = document.createElement('input'); input.type='file'; input.accept='application/json'; input.onchange = ()=>{ const f = input.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = e=>{ try{ const data = JSON.parse(e.target.result); if(data.aprobados) localStorage.setItem(LS_KEY_APPROVED, JSON.stringify(data.aprobados)); alert('Importado. Se recargará la página.'); location.reload(); }catch(err){ alert('Archivo inválido'); } }; reader.readAsText(f); }; input.click(); });

// Inicialización
function init(){ crearRamosDesdeJSON(); cargarAprobados(); actualizarCreditos(); drawAllLines(); window.addEventListener('resize', ()=>{ drawAllLines(); }); }

window.addEventListener('load', ()=>{ setTimeout(init,120); });
</script>
</body>
</html>
